<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Out of inodes | Articles by Adam Garstang</title>
    <link rel="shortcut icon" type="image/png" href="http://www.adamgarstang.co.uk/favicon.png">
    <link rel="shortcut icon" type="image/x-icon" href="http://www.adamgarstang.co.uk/favicon.ico">
    <link href="http://www.adamgarstang.co.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Out of inodes Full Atom Feed" />
    <link href="http://www.adamgarstang.co.uk/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Out of inodes Full RSS Feed" />
    <link rel="stylesheet" href="http://www.adamgarstang.co.uk/theme/css/screen.css" type="text/css" />
    <link rel="stylesheet" href="http://www.adamgarstang.co.uk/theme/css/pygments.css" type="text/css" />
    <link rel="stylesheet" href="http://www.adamgarstang.co.uk/theme/css/print.css" type="text/css" media="print" />
    <meta name="generator" content="Pelican" />
</head>
<body>
    <header>
        <nav>
            <ul>

                <li class="ephemeral selected"><a href="http://www.adamgarstang.co.uk/author/adam-garstang.html">Adam Garstang</a></li>
                <li><a href="http://www.adamgarstang.co.uk">Home</a></li>
                <li><a href="http://www.adamgarstang.co.uk/pages/about-me.html">About Me</a></li>
                <li><a href="http://www.adamgarstang.co.uk/pages/contact-me.html">Contact Me</a></li>
            </ul>
        </nav>
        <div class="header_box">
            <h1><a href="http://www.adamgarstang.co.uk">Out of inodes</a></h1>
            <h2>This is not a blog by Adam Garstang.</h2>
        </div>
    </header>
    <div id="wrapper">
        <div id="content">            <h4 class="date">Nov 20, 2014</h4>

            <article class="post">
                <h2 class="title">
                    <a href="http://www.adamgarstang.co.uk/powershell-office365.html" rel="bookmark" title="Permanent Link to &quot;Connect-Office365 Powershell Module&quot;">Connect-Office365 Powershell Module</a>
                </h2>

                <p>Connecting to Office365 can be a bit of a chore. This is a nice and quick module
to get you connected to Microsoft Online and Exchange Online management.</p>
<p>You will need the <a href="http://technet.microsoft.com/en-us/library/hh974317.aspx">Microsoft Online Powershell Modules</a>.</p>
<p>Then download Connect-Office365.psm1 from <a href="https://github.com/agarstang/Connect-Office365">here</a></p>
<h2>Powershell Modules</h2>
<p>To make the command always available you need to store the module somewhere Powershell will know to load it from.</p>
<p>These locations can be found on the PSModulePath Environment Variable (<code>$env:PSModulePath</code>).</p>
<p>I am going to store it in my user modules directory <code>Documents\WindowsPowerShell\Modules</code>; 
if this path doesn't exist then create it.</p>
<p>In order for the module to load it needs to be a <a href="http://msdn.microsoft.com/en-us/library/dd878350%28v=vs.85%29.aspx">well formed module</a>.
It needs to be stored in a directory of a name (usually the module name) and at least one Powershell file with the same name.</p>
<p>In this instance: <code>Documents\WindowsPowerShell\Modules\Connect-Office365\Connect-Office365.psm1</code></p>
                <div class="clear"></div>

                <div class="info">
                    <a href="http://www.adamgarstang.co.uk/powershell-office365.html">posted at 22:00</a>
                    &nbsp;&middot;&nbsp;<a href="http://www.adamgarstang.co.uk/category/windows.html" rel="tag">Windows</a>
                    &nbsp;&middot;
                    &nbsp;<a href="http://www.adamgarstang.co.uk/tag/powershell.html" class="tags">Powershell</a>
                    &nbsp;<a href="http://www.adamgarstang.co.uk/tag/office365.html" class="tags">Office365</a>
                </div>
		<a href="http://www.adamgarstang.co.uk/powershell-office365.html#disqus_thread">Click to read and post comments</a>
            </article>
            <article class="post">
                <h2 class="title">
                    <a href="http://www.adamgarstang.co.uk/win10-wsl.html" rel="bookmark" title="Permanent Link to &quot;Windows Subsystem for Linux (WSL)&quot;">Windows Subsystem for Linux (WSL)</a>
                </h2>

                <p>Recently I have been playing around with the Windows Subsystem for Linux, Microsoft's attempt to bring Bash (and in this implementation, most of Ubuntu) to the Windows world.  </p>
<p>Running Bash on Windows was never a major desire of mine (despite being a long time Linux user and admin). Powershell has brought, well, <em>powerful</em> scripting to Windows and I have loved it since my first major projects using it. Keeping Linux tooling to my Linux VM just feels cleaner.  </p>
<p>The curiosity that had me install WSL was simply SSH. SSH'ing from Windows is pretty terrible, PuTTY (and it's surrounding tools) are solid but it's just not as friendly as native SSH.<br />
So I installed WSL (instructions below), got to the bash prompt and SSH'd to a host (<em>wooo</em>).  </p>
<p>The next thing I attempted was getting the running ssh-agent.</p>
<div class="highlight"><pre><span></span>eval `ssh-agent -s`
</pre></div>


<p>Again, this worked perfectly (another <em>wooo</em>). Feeling pretty much like I'm on an Ubuntu VM at this point.</p>
<p>Excellent, now I can SSH to all my hosts using my SSH keys. Now I just need to run <code>screen</code> so I can hop between them... <strong><em>error</em></strong>. <a href="https://github.com/Microsoft/BashOnWindows/issues/39">It's known</a> that screen does not currently work in WSL. <strong>However</strong>, this isn't much of a problem as each Window is part of the same session; therefore I can simply use multiple windows and SSH from each when utilizing the same ssh-agent.  </p>
<p>So the last thing I'd like, to complete the workflow improvements I'm looking for, is SSH tunnels. This works, but not fully. <code>netstat</code> shows nothing listening inside my other Bash window (no connections at all actually), however I can see the port listening in Windows. I tested and I can connect over the tunnel from Windows... using PuTTY :).</p>
<p>The SSH tunnel issue isn't going to stop me using this as my primary SSH client on Winodws and I'm sure the have Bash will help working on cross platform OSS projects. For my day-to-day Windows scripting I will continue using Powershell.</p>
<h2>Installing</h2>
<ol>
<li>Go to Start &gt; Settings &gt; Update &amp; Security &gt; For Developers, enable Developer Mode and restart.</li>
<li>Go to Start &gt; Turn Windows Feature on or off, tick "Winodws Subsystem for Linux (Beta)" and click Ok.</li>
<li>Restart.</li>
<li>Right click on the Start button and select "Run", type "bash" and click Ok. This will download and install the Ubuntu installation that powers Bash for Windows.</li>
<li>Close the Window. At this point "Bash on Ubuntu on Winodws" should exist in your Start Menu, run it.</li>
<li>Once at the Bash prompt run <code>sudo apt update</code> &amp; <code>sudo apt upgrade</code></li>
</ol>
                <div class="clear"></div>

                <div class="info">
                    <a href="http://www.adamgarstang.co.uk/win10-wsl.html">posted at 22:00</a>
                    &nbsp;&middot;&nbsp;<a href="http://www.adamgarstang.co.uk/category/windows.html" rel="tag">Windows</a>
                    &nbsp;&middot;
                    &nbsp;<a href="http://www.adamgarstang.co.uk/tag/windows.html" class="tags">Windows</a>
                    &nbsp;<a href="http://www.adamgarstang.co.uk/tag/linux.html" class="tags">Linux</a>
                    &nbsp;<a href="http://www.adamgarstang.co.uk/tag/ubuntu.html" class="tags">Ubuntu</a>
                </div>
		<a href="http://www.adamgarstang.co.uk/win10-wsl.html#disqus_thread">Click to read and post comments</a>
            </article>            <h4 class="date">Sep 24, 2014</h4>

            <article class="post">
                <h2 class="title">
                    <a href="http://www.adamgarstang.co.uk/puppet-requesttracker.html" rel="bookmark" title="Permanent Link to &quot;Puppet Request Tracker 4 on Ubuntu Trusty&quot;">Puppet Request Tracker 4 on Ubuntu Trusty</a>
                </h2>

                <p><a href="https://github.com/agarstang/puppet-requesttracker4">Basic Puppet module for deploying Request Tracker 4 to Ubuntu Trusty LTS.</a></p>
<p>This is not designed to be very neat/friendly. Following the philosophy that as much
of our infrastructure should be quickly re-deployable I required a way to quickly deploy
our latest RT version and exim config to our server.</p>
<p>I imagine a lot of cases are similar to our own where the email address you
want to use for Tracker is on an existing domain. The exim config expects mail
to be relayed to it from your primary MTA or Exchange server and to smarthost
mail outbound via your existing infrastructure. It performs SQL queries against
the trakcer database to figure out which queue mail is destined for.</p>
<p>It's currently hard coded to using RT-4.2.6 and Postgres (database setup not
included - perhaps speak to your db admin).</p>
<p>I am manually installing the majority of dependencies as CPAN was not compiling
many of them on Trusty. With the majority of them available from packages I 
created this list and installed the remainder using the then functioning makefile.</p>
<p>Replace SSL certs in apache template with your own.</p>
                <div class="clear"></div>

                <div class="info">
                    <a href="http://www.adamgarstang.co.uk/puppet-requesttracker.html">posted at 19:30</a>
                    &nbsp;&middot;&nbsp;<a href="http://www.adamgarstang.co.uk/category/linux.html" rel="tag">Linux</a>
                    &nbsp;&middot;
                    &nbsp;<a href="http://www.adamgarstang.co.uk/tag/linux.html" class="tags">Linux</a>
                    &nbsp;<a href="http://www.adamgarstang.co.uk/tag/ubuntu.html" class="tags">Ubuntu</a>
                    &nbsp;<a href="http://www.adamgarstang.co.uk/tag/puppet.html" class="tags">Puppet</a>
                    &nbsp;<a href="http://www.adamgarstang.co.uk/tag/rt.html" class="tags">RT</a>
                </div>
		<a href="http://www.adamgarstang.co.uk/puppet-requesttracker.html#disqus_thread">Click to read and post comments</a>
            </article>            <h4 class="date">Jun 27, 2014</h4>

            <article class="post">
                <h2 class="title">
                    <a href="http://www.adamgarstang.co.uk/vagrant-ubuntu.html" rel="bookmark" title="Permanent Link to &quot;Vagrant Ubuntu Box Build&quot;">Vagrant Ubuntu Box Build</a>
                </h2>

                <p>My notes on how to build a base Vagrant box.
I created these when I needed a box based on a Ubuntu Trusty dev build.</p>
<p>You should have <a href="https://www.virtualbox.org/">VirtualBox</a> and 
<a href="http://www.vagrantup.com/">Vagrant</a> installed and working.</p>
<h2>Virtual Box</h2>
<p>Make sure you have VirtualBox version 4.3.4 or greater.</p>
<p>The reason select this version or greater is that when I first built
this box I used an earlier version with an earlier version of Guest Additions
that did not support Shared Folders in kernel version used in Trusty.</p>
<p>NOTE: I tend refrain from updating VirtualBox to keep my version matching the 
Guest Additions installed in my base boxes.</p>
<h3>Setup Virtual Machine</h3>
<p>Create a new Virtual Machine.</p>
<ul>
<li>Name: vagrant-trusty64</li>
<li>Memory: 512MB</li>
<li>Disk: Dynamic VMDK 40GB</li>
<li>Network 1: Attached to NAT</li>
<li>Port forward: SSH 2222 -&gt; 22</li>
<li>Disable Audio</li>
<li>Disable USB</li>
<li>Mount Ubuntu ISO</li>
</ul>
<p>Boot the Virtual Machine to start the Ubuntu installation.</p>
<h2>Ubuntu Installation</h2>
<ul>
<li>At the main menu press F4 to select Minimal Virtual Machine
 then start the installation.</li>
<li>Select your keyboard layout.</li>
<li>Set hostname to "vagrant-trusty64"</li>
<li>Create a user called "vagrant" with username "vagrant" and password "vagrant"</li>
<li>Set Disk partitioning to use entire disk.</li>
<li>From the features list select OpenSSH server.</li>
</ul>
<h2>Ubuntu Configuration</h2>
<p>Once the Ubuntu box is booted log in with the "vagrant" user and drop to root
with <code>sudo -i</code>.</p>
<h3>Sudoers</h3>
<p>Create and admin group to contain users who can sudo without authentication;
This will include the "vagrant" user.</p>
<div class="highlight"><pre><span></span>groupadd admin
usermod -G admin vagrant
</pre></div>


<p>Edit the sudoers file with <code>visudo</code> and ensure it has the following set.</p>
<div class="highlight"><pre><span></span><span class="n">Defaults</span> <span class="n">env_keep</span> <span class="o">=</span> <span class="s">&quot;SSH_AUTH_SOCK&quot;</span>
<span class="nf">%admin</span> <span class="n">ALL</span><span class="o">=</span><span class="nl">NOPASSWD</span><span class="p">:</span> <span class="n">ALL</span>
</pre></div>


<h3>Vagrant SSH Key</h3>
<p>Download and install Vagrant's public key into
the "vagrant" users authorized_keys.</p>
<div class="highlight"><pre><span></span>mkdir -p /home/vagrant/.ssh
chmod <span class="m">0700</span> /home/vagrant/.ssh
wget --no-check-certificate <span class="se">\</span>
    https://raw.github.com/mitchellh/vagrant/master/keys/vagrant.pub <span class="se">\</span>
    -O /home/vagrant/.ssh/authorized_keys
chmod <span class="m">0600</span> /home/vagrant/.ssh/authorized_keys
chown -R vagrant /home/vagrant/.ssh
</pre></div>


<p>Edit /etc/ssh/sshd_config and ensure it contains the following.</p>
<div class="highlight"><pre><span></span>Port 22
PubKeyAuthentication yes
AuthorizedKeysFile %h/.ssh/authorized_keys
PermitEmptyPasswords no
PasswordAuthentication no
</pre></div>


<h3>Base Packages</h3>
<p>Now we need to install the base packages. Anything required for provisioning.</p>
<div class="highlight"><pre><span></span>apt-get install -y ruby rubygems puppet chef
</pre></div>


<h3>VirtualBox Guest Additions</h3>
<p>Install the prerequisites.</p>
<div class="highlight"><pre><span></span>apt-get install -y gcc build-essential linux-headers-server
</pre></div>


<p>Mount the GA ISO from <strong>Devices &gt; Install Guest Additions</strong></p>
<p>Browse to the CD and run the installation script.</p>
<p><strong>NOTE:</strong> At this point reboot the machine and and log in before shutting
it down for packaging. I had problems with Guest Additions if I immediately 
shutdown and packaged the box using Vagrant.</p>
<h2>Package With Vagrant</h2>
<p>Now we create the vagrant <code>.box</code> file with Vagrant.</p>
<div class="highlight"><pre><span></span>vagrant package -base vagrant-trusty64
vagnant box add -name trusty64 ./vagrant-trusty64.box
</pre></div>
                <div class="clear"></div>

                <div class="info">
                    <a href="http://www.adamgarstang.co.uk/vagrant-ubuntu.html">posted at 19:30</a>
                    &nbsp;&middot;&nbsp;<a href="http://www.adamgarstang.co.uk/category/linux.html" rel="tag">Linux</a>
                    &nbsp;&middot;
                    &nbsp;<a href="http://www.adamgarstang.co.uk/tag/linux.html" class="tags">Linux</a>
                    &nbsp;<a href="http://www.adamgarstang.co.uk/tag/ubuntu.html" class="tags">Ubuntu</a>
                    &nbsp;<a href="http://www.adamgarstang.co.uk/tag/vagrant.html" class="tags">Vagrant</a>
                </div>
		<a href="http://www.adamgarstang.co.uk/vagrant-ubuntu.html#disqus_thread">Click to read and post comments</a>
            </article>            <h4 class="date">Jun 24, 2014</h4>

            <article class="post">
                <h2 class="title">
                    <a href="http://www.adamgarstang.co.uk/ipxe-sysrescue.html" rel="bookmark" title="Permanent Link to &quot;iPXE Booting Sysrescue Linux&quot;">iPXE Booting Sysrescue Linux</a>
                </h2>

                <p>This is a brief walkthrough on how to iPXE netboot Sysrescue Linux over HTTP.
It is simply a correlation of the information I gathered while searching online.</p>
<p>In this guide a single Ubuntu 14.04 (hostname: duke) box will have the following roles:</p>
<ul>
<li>TFTP Server - Legacy systems without iPXE will boot an image from here.</li>
<li>HTTP Server - We will use Ubuntu's default Apache from the repositories. HTTP is faster than TFTP</li>
<li>DHCP Server - In most cases this will likely by elsewhere however we will configure. ISC DHCP Server here.</li>
</ul>
<p>Lets assume DNS is working.</p>
<h2>Packages</h2>
<p>Install the necessary packages.</p>
<div class="highlight"><pre><span></span>apt-get install -y isc-dhcp-server
apt-get install -y tftpd-hpa apache2
</pre></div>


<h2>Fallback Image</h2>
<p>Download the fallback iPXE image for legacy network cards.</p>
<div class="highlight"><pre><span></span>wget http://boot.ipxe.org/undionly.kpxe -O /var/lib/tftpboot/undionly.kpxe
</pre></div>


<h2>Configure DHCP Server</h2>
<p>Add the following to your dhcpd.conf file. You can either add it as to a
subnet declaration of a specific hosts declaration.</p>
<div class="highlight"><pre><span></span>  <span class="nt">if</span> <span class="nt">exists</span> <span class="nt">ipxe</span><span class="nc">.http</span> <span class="nt">and</span> <span class="nt">exists</span> <span class="nt">user-class</span> <span class="nt">and</span> <span class="nt">option</span> <span class="nt">user-class</span> <span class="o">=</span> <span class="s2">&quot;iPXE&quot;</span> <span class="p">{</span>
    <span class="n">filename</span> <span class="s2">&quot;http://duke/boot.php&quot;</span><span class="p">;</span>
  <span class="p">}</span> <span class="nt">else</span> <span class="p">{</span>
    <span class="n">filename</span> <span class="s2">&quot;undionly.kpxe&quot;</span><span class="p">;</span>
  <span class="p">}</span>
</pre></div>


<h2>Create iPXE Config</h2>
<p>In the root of your webserver (default /var/www) create boot.php.
This will provide menu for selecting your Sysrescue version and allow you
to differentiate between the any other OS/options you chose to add.
Content:</p>
<div class="highlight"><pre><span></span><span class="ch">#!ipxe</span>

menu
item sysrescue64  Boot Linux SysRescue 64-bit
item sysrescue32  Boot Linux SysRescue 32-bit
choose target <span class="o">&amp;&amp;</span> goto <span class="si">${</span><span class="nv">target</span><span class="si">}</span>

:sysrescue64
<span class="nb">echo</span> Booting Sysrescue
<span class="nb">set</span> base-url http://duke/sysrescue
kernel <span class="si">${</span><span class="nv">base</span><span class="p">-url</span><span class="si">}</span>/rescue64 <span class="nv">scandelay</span><span class="o">=</span><span class="m">1</span> nomodeset <span class="nv">vga</span><span class="o">=</span><span class="m">791</span> <span class="nv">netboot</span><span class="o">=</span><span class="si">${</span><span class="nv">base</span><span class="p">-url</span><span class="si">}</span>/sysrcd.dat
initrd <span class="si">${</span><span class="nv">base</span><span class="p">-url</span><span class="si">}</span>/initram.igz
boot <span class="o">||</span>
<span class="c1"># If everything failed, give the user some options</span>
<span class="nb">echo</span> Boot from <span class="si">${</span><span class="nv">base</span><span class="p">-url</span><span class="si">}</span> failed
prompt --key 0x197e --timeout <span class="m">2000</span> Press F12 to investigate <span class="o">||</span> <span class="nb">exit</span>
shell
<span class="nb">exit</span>

:sysrescue32
<span class="nb">echo</span> Booting Sysrescue
<span class="nb">set</span> base-url http://duke/sysrescue
kernel <span class="si">${</span><span class="nv">base</span><span class="p">-url</span><span class="si">}</span>/rescue32 <span class="nv">scandelay</span><span class="o">=</span><span class="m">1</span> nomodeset <span class="nv">vga</span><span class="o">=</span><span class="m">791</span> <span class="nv">netboot</span><span class="o">=</span><span class="si">${</span><span class="nv">base</span><span class="p">-url</span><span class="si">}</span>/sysrcd.dat
initrd <span class="si">${</span><span class="nv">base</span><span class="p">-url</span><span class="si">}</span>/initram.igz
boot <span class="o">||</span>
<span class="c1"># If everything failed, give the user some options</span>
<span class="nb">echo</span> Boot from <span class="si">${</span><span class="nv">base</span><span class="p">-url</span><span class="si">}</span> failed
prompt --key 0x197e --timeout <span class="m">2000</span> Press F12 to investigate <span class="o">||</span> <span class="nb">exit</span>
shell
<span class="nb">exit</span>
</pre></div>


<h2>Sysrescue Files</h2>
<p>Now we need the necessary files off the Sysrescue CD to your webroot.
Copy the following files off:</p>
<ul>
<li>isolinux/initram.igz</li>
<li>isolinux/rescue32</li>
<li>isolinux/rescue64</li>
<li>sysrcd.dat</li>
<li>sysrcd.md5</li>
</ul>
<p>If you have the ISO you can mount it to extract the files as below.</p>
<div class="highlight"><pre><span></span>mkdir /mnt/iso
mount -o loop sysrescue.iso /mnt/iso
mkdir /var/www/sysrescue
cp -r /mnt/iso/isolinux/initram.igz /var/www/html/sysrescue/
cp -r /mnt/iso/isolinux/rescue32 /var/www/html/sysrescue/
cp -r /mnt/iso/isolinux/rescue64 /var/www/html/sysrescue/
cp -r /mnt/iso/sysrcd.dat /var/www/html/sysrescue/
cp -r /mnt/iso/sysrcd.md5 /var/www/html/sysrescue/
umount /mnt/iso
</pre></div>


<h2>Fin</h2>
<p>Now if all your services are running you should be able to PXE boot your system.
You will get to a menu giving you the option to boot either 32-bit or 64-bit Sysrescue.</p>
<h2>Appendix</h2>
<p>Make sure you grab the latest version of Sysrescue, older version may not have the NIC
drivers required to netboot.
In the boot.php I set <code>vga=791</code> on modern servers this seems to get prevent GFX issues.</p>
                <div class="clear"></div>

                <div class="info">
                    <a href="http://www.adamgarstang.co.uk/ipxe-sysrescue.html">posted at 17:30</a>
                    &nbsp;&middot;&nbsp;<a href="http://www.adamgarstang.co.uk/category/linux.html" rel="tag">Linux</a>
                    &nbsp;&middot;
                    &nbsp;<a href="http://www.adamgarstang.co.uk/tag/linux.html" class="tags">Linux</a>
                    &nbsp;<a href="http://www.adamgarstang.co.uk/tag/ipxe.html" class="tags">iPXE</a>
                    &nbsp;<a href="http://www.adamgarstang.co.uk/tag/netboot.html" class="tags">netboot</a>
                    &nbsp;<a href="http://www.adamgarstang.co.uk/tag/sysrescue.html" class="tags">Sysrescue</a>
                    &nbsp;<a href="http://www.adamgarstang.co.uk/tag/ubuntu.html" class="tags">Ubuntu</a>
                </div>
		<a href="http://www.adamgarstang.co.uk/ipxe-sysrescue.html#disqus_thread">Click to read and post comments</a>
            </article>

            <div class="clear"></div>
            <footer>
                <p>
                <a href="https://github.com/jody-frankowski/blue-penguin">Blue Penguin</a> Theme
                &middot;
                Powered by <a href="http://getpelican.com">Pelican</a>
                &middot;
                <a href="http://www.adamgarstang.co.uk/feeds/all.atom.xml" rel="alternate">Atom Feed</a>
                &middot;
                <a href="http://www.adamgarstang.co.uk/feeds/all.rss.xml" rel="alternate">Rss Feed</a>
            </footer>
        </div>
        <div class="clear"></div>
    </div>
</body>
</html>